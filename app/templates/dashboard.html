{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1><span class="music-icon">ðŸŽµ</span>Welcome to MAPP<span class="music-icon">ðŸŽµ</span></h1>
    <div class="subheading-container">
        <h2>Music Analysis and Pattern Prediction</h2>
        <h3>To help you find your way!</h3>
    </div>
    <div class="animated-text-container">
        <div class="animated-text">
            <p>Unleash the power of AI to analyze your music and gain valuable insights. Perfect for musicians, artists, songwriters, and producers.</p>
            <p>Find out your hit potential by seeing how your song compares to artists whose songs chart on popular charts like Billboard Hot 100!</p>
            <p>Get realtime analytics that show your track's strengths and areas where you could benefit from constructive criticism.</p>
            <p>Get insightful, easy to read charts and have our dynamic AI-powered system provide suggestions for your song's structure, lyrics, and songwriting techniques.</p>
            <p>We know how hard you work so, why not let us clear the path to help you find your way?</p>
        </div>
    </div>
    
    <div class="upload-section">
        <h2>Upload Your Track</h2>
        <form id="analysis-form" action="{{ url_for('api.analyze_song') }}" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".mp3,.wav" required>
            <input type="text" name="title" placeholder="Song Title" required>
            <input type="text" name="artist" placeholder="Artist" required>
            <select name="year" required style="display: block; width: 103%; height: 35px; padding: 8px; margin-bottom: 10px; border: 1px solid #64ffda; border-radius: 4px; background: rgba(255, 255, 255, 0.1); color: #e0e0e0;">
                {% for year in range(current_year, current_year - 6, -1) %}
                    <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
            </select>
            <input type="text" name="producer" placeholder="Producer">
            <button type="submit" style="display: block; width: calc(103%); margin: 0 -1px;">Analyze Track</button>
        </form>
    </div>
</div>

<script>
    const canvas = document.getElementById('wave-background');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const centerY = canvas.height / 2;
    const waveCount = 5;
    const baseAmplitude = canvas.height / 8;
    const frequency = 0.01;
    const speed = 0.002;

    function drawWave(time, depth) {
        ctx.beginPath();
        for (let x = 0; x < canvas.width; x += 2) {
            const y = centerY + 
                Math.sin(x * frequency + time * speed) * baseAmplitude * (1 - depth / waveCount) +
                Math.sin(x * frequency * 2 + time * speed * 1.5) * baseAmplitude / 2 * (1 - depth / waveCount);
            ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    function animate(time) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw central light
        const gradient = ctx.createRadialGradient(canvas.width / 2, centerY, 0, canvas.width / 2, centerY, canvas.height / 2);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
        gradient.addColorStop(1, 'rgba(91, 194, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw waves
        for (let i = 0; i < waveCount; i++) {
            ctx.strokeStyle = `rgba(91, 194, 255, ${0.7 - i * 0.1})`;
            ctx.lineWidth = 2 - i * 0.3;
            drawWave(time, i);
        }

        requestAnimationFrame(animate);
    }

    animate(0);

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        centerY = canvas.height / 2;
    });

    document.getElementById('analysis-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // Show loading overlay
        document.querySelector('.loading-overlay').style.display = 'flex';
        
        fetch("{{ url_for('api.analyze_song') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading overlay
            document.querySelector('.loading-overlay').style.display = 'none';
            
            if (data.lyrics_detected === false) {
                document.getElementById('lyrics-input-container').style.display = 'block';
            } else {
                // Handle successful analysis
                console.log('Analysis complete:', data);
            }
        })
        .catch(error => {
            // Hide loading overlay and show error
            document.querySelector('.loading-overlay').style.display = 'none';
            console.error('Error:', error);
            alert('An error occurred during analysis. Please try again.');
        });
    });

    document.getElementById('submit-lyrics').addEventListener('click', function() {
        const lyrics = document.getElementById('lyrics-input').value;
        // Send lyrics to backend
        fetch("{{ url_for('api.submit_lyrics') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({lyrics: lyrics})
        })
        .then(response => response.json())
        .then(data => {
            console.log('Lyrics submitted:', data);
            // Handle response
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Initialize year picker for all year inputs on the page
    document.addEventListener('DOMContentLoaded', function() {
        // Get all year inputs on the page
        const yearInputs = document.querySelectorAll('.year-input');
        
        yearInputs.forEach(yearInput => {
            const yearDropdown = yearInput.nextElementSibling;
            const currentYear = new Date().getFullYear();
            
            // Clear existing options
            yearDropdown.innerHTML = '';
            
            // Populate years
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('div');
                option.className = 'year-option';
                option.textContent = year;
                
                if (year === currentYear) {
                    option.classList.add('selected');
                    yearInput.value = year;
                }
                
                option.addEventListener('click', () => {
                    yearInput.value = year;
                    yearDropdown.querySelectorAll('.year-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    option.classList.add('selected');
                    yearDropdown.style.display = 'none';
                });
                
                yearDropdown.appendChild(option);
            }
            
            // Toggle dropdown
            yearInput.addEventListener('click', (e) => {
                e.stopPropagation();
                const allDropdowns = document.querySelectorAll('.year-dropdown');
                allDropdowns.forEach(dropdown => {
                    if (dropdown !== yearDropdown) {
                        dropdown.style.display = 'none';
                    }
                });
                yearDropdown.style.display = yearDropdown.style.display === 'block' ? 'none' : 'block';
            });
        });
        
        // Close all dropdowns when clicking outside
        document.addEventListener('click', () => {
            const dropdowns = document.querySelectorAll('.year-dropdown');
            dropdowns.forEach(dropdown => dropdown.style.display = 'none');
        });
    });

    // Animated text
    document.addEventListener('DOMContentLoaded', function() {
        const animatedText = document.querySelector('.animated-text');
        
        function resetAnimation() {
            animatedText.style.animation = 'none';
            animatedText.offsetHeight; // Trigger reflow
            animatedText.style.animation = null;
        }

        animatedText.addEventListener('animationiteration', resetAnimation);
    });

    document.addEventListener('DOMContentLoaded', function() {
        const yearInput = document.querySelector('.year-input');
        const yearScroll = document.querySelector('.year-scroll');
        const yearOptions = document.querySelectorAll('.year-option');
        
        yearInput.addEventListener('click', (e) => {
            e.stopPropagation();
            yearScroll.style.display = yearScroll.style.display === 'block' ? 'none' : 'block';
            
            if (yearScroll.style.display === 'block') {
                const selectedOption = document.querySelector(`.year-option[data-year="${yearInput.value}"]`);
                if (selectedOption) {
                    selectedOption.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    selectedOption.classList.add('selected');
                }
            }
        });
        
        yearOptions.forEach(option => {
            option.addEventListener('click', () => {
                yearInput.value = option.dataset.year;
                yearOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                yearScroll.style.display = 'none';
            });
        });
        
        document.addEventListener('click', (e) => {
            if (!yearInput.contains(e.target) && !yearScroll.contains(e.target)) {
                yearScroll.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
